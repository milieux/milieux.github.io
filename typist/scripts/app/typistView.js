define(["backbone"],function(e){return e.View.extend({el:"#typist",events:{"keyup .entry":"onKeypress","click .reload":"resetWords"},initialize:function(){this.$input=this.$("input"),this.$reload=this.$(".reload"),this.$timer=this.$(".timer"),this.statsTemplate=_.template($("#stats").html()),this.resetUI()},render:function(){var e=this,t=e.collection.typed().length,n=e.collection.correct().length,r=t-n;return $(this.el).append(this.statsTemplate({typed:t,correct:n,incorrect:r,keystrokes:e.keystrokes})),this.$stats=this.$(".stats"),this},isModelActive:function(){return this.activeModel=this.collection.active(),this.activeModel?!0:!1},onKeypress:function(e){var t=this;this.timeIsRunning||(this.timeIsRunning=!0,this.initTimer());if(!this.isModelActive()){this.complete();return}this.keystrokes++;var n=t.activeModel.get("text"),r=this.$input.val(),i=$.trim(r),s=e.which;if(!i.length){this.$input.val("");return}t.activeModel.get("typed")===!1&&t.activeModel.set({typed:!0});if(s===32){i===n?t.activeModel.set({correct:!0}):t.activeModel.set({correct:!1}),this.clearWord(),this.isModelActive()||this.complete();return}r.split("").forEach(function(e,r){if(e!==n.charAt(r)){t.activeModel.set({correct:!1});return}})},clearWord:function(){this.$input.val(""),this.activeModel.set({active:!1}),this.collection.setNextActive(this.activeModel)},initTimer:function(){function n(){var r=t--,i=(r>9?r:"0"+r).toString();e.$timer.text("0:"+i);if(r===0){e.complete();return}e.timeout=setTimeout(n,1e3)}var e=this,t=59;this.timeout=setTimeout(n,1e3)},complete:function(){this.$input.prop("disabled",!0),this.render(),window.clearTimeout(this.timeout)},resetUI:function(){this.keystrokes=0,this.timeIsRunning=!1,this.$timer.text("1:00"),this.$reload.prop("disabled",!1),this.$input.prop("disabled",!1).val("").focus()},resetWords:function(){window.clearTimeout(this.timeout),this.collection.trigger("refresh"),this.resetUI(),this.$stats&&this.$stats.remove()}})});